<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Certificates | Mental Health Education Platform</title>
  <meta content="View and download your earned certificates" name="description">

  <!-- Favicons -->
  <link href="../images/wellness-site-icon.jpg" rel="icon">

  <!-- Google Fonts -->
  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">

  <!-- Custom Branding -->
  <style>
    :root {
      --rps-navy: #1e3a5f;
      --rps-blue: #4a90e2;
      --rps-light-blue: #e3f2fd;
    }
    .sidebar {
      background: var(--rps-navy);
    }
    .btn-primary {
      background: var(--rps-blue);
      border-color: var(--rps-blue);
    }
    .certificate-card {
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      transition: all 0.3s;
      overflow: hidden;
    }
    .certificate-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      border-color: var(--rps-blue);
    }
    .certificate-preview {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 3rem;
    }
    .certificate-badge {
      font-size: 4rem;
      color: #ffd700;
    }
    .share-btn {
      margin: 0 5px;
    }
  </style>
</head>

<body>

  <!-- ======= Header ======= -->
  <header id="header" class="header fixed-top d-flex align-items-center">
    <div class="d-flex align-items-center justify-content-between">
      <a href="dashboard.html" class="logo d-flex align-items-center">
        <img src="../SoloFrameHub-logo.png" alt="Logo" style="max-height: 40px;">
        <span class="d-none d-lg-block ms-2">Student Portal</span>
      </a>
      <i class="bi bi-list toggle-sidebar-btn"></i>
    </div>

    <nav class="header-nav ms-auto">
      <ul class="d-flex align-items-center">
        <li class="nav-item dropdown pe-3">
          <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
            <img src="assets/img/profile-img.jpg" alt="Profile" class="rounded-circle">
            <span class="d-none d-md-block dropdown-toggle ps-2" id="user-name">Loading...</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
            <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person"></i> My Profile</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="signOut(); return false;"><i class="bi bi-box-arrow-right"></i> Sign Out</a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </header><!-- End Header -->

  <!-- ======= Sidebar ======= -->
  <aside id="sidebar" class="sidebar">
    <ul class="sidebar-nav">
      <li class="nav-item">
        <a class="nav-link collapsed" href="dashboard.html">
          <i class="bi bi-grid"></i>
          <span>Dashboard</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link collapsed" href="my-courses.html">
          <i class="bi bi-book"></i>
          <span>My Courses</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="certificates.html">
          <i class="bi bi-award"></i>
          <span>Certificates</span>
        </a>
      </li>
      <li class="nav-heading">External Links</li>
      <li class="nav-item">
        <a class="nav-link collapsed" href="../community.html" target="_blank">
          <i class="bi bi-people"></i>
          <span>Community Forum</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link collapsed" href="../courses.html">
          <i class="bi bi-shop"></i>
          <span>Browse All Courses</span>
        </a>
      </li>
      <li class="nav-heading">Settings</li>
      <li class="nav-item">
        <a class="nav-link collapsed" href="profile.html">
          <i class="bi bi-person"></i>
          <span>Profile</span>
        </a>
      </li>
    </ul>
  </aside><!-- End Sidebar-->

  <main id="main" class="main">

    <div class="pagetitle">
      <h1>My Certificates</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="dashboard.html">Home</a></li>
          <li class="breadcrumb-item active">Certificates</li>
        </ol>
      </nav>
    </div>

    <section class="section">

      <!-- Summary Cards -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card info-card">
            <div class="card-body">
              <h5 class="card-title">Total Certificates</h5>
              <div class="d-flex align-items-center">
                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="background: #e3f2fd; color: #4a90e2;">
                  <i class="bi bi-award"></i>
                </div>
                <div class="ps-3">
                  <h6 id="total-certificates">0</h6>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card info-card">
            <div class="card-body">
              <h5 class="card-title">Courses Completed</h5>
              <div class="d-flex align-items-center">
                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="background: #e8f5e9; color: #4caf50;">
                  <i class="bi bi-check-circle"></i>
                </div>
                <div class="ps-3">
                  <h6 id="completed-courses">0</h6>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card info-card">
            <div class="card-body">
              <h5 class="card-title">In Progress</h5>
              <div class="d-flex align-items-center">
                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="background: #fff3e0; color: #ff9800;">
                  <i class="bi bi-clock-history"></i>
                </div>
                <div class="ps-3">
                  <h6 id="in-progress-courses">0</h6>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Certificates Grid -->
      <div class="row" id="certificates-grid">
        <div class="col-12 text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3">Loading your certificates...</p>
        </div>
      </div>

    </section>

  </main><!-- End #main -->

  <!-- ======= Footer ======= -->
  <footer id="footer" class="footer">
    <div class="copyright">
      &copy; 2025 <strong><span>Mental Health Education Platform</span></strong>. All Rights Reserved
    </div>
  </footer><!-- End Footer -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/main.js"></script>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

    let supabaseClient = null;

    if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
      supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    const allCoursesData = {
      1: { title: 'Movement Medicine: Exercise for Mental Health', slug: 'course-1-movement-medicine', total_lessons: 20 },
      2: { title: 'Workplace Mental Health & Professional Development', slug: 'course-2-workplace-mental-health', total_lessons: 20 },
      3: { title: 'Digital Wellness & Technology Balance', slug: 'course-3-digital-wellness', total_lessons: 20 },
      4: { title: 'Growth Mindset for Lasting Change', slug: 'course-4-growth-mindset', total_lessons: 20 },
      5: { title: 'CBT Fundamentals', slug: 'course-5-cbt-fundamentals', total_lessons: 20 }
    };

    async function loadCertificates() {
      try {
        if (supabaseClient) {
          await loadCertificatesWithSupabase();
        } else {
          loadCertificatesDemo();
        }
      } catch (error) {
        console.error('Error:', error);
        loadCertificatesDemo();
      }
    }

    async function loadCertificatesWithSupabase() {
      const { data: { user } } = await supabaseClient.auth.getUser();

      if (!user) {
        loadCertificatesDemo();
        return;
      }

      document.getElementById('user-name').textContent = user.user_metadata?.full_name || 'Student';

      // Get all enrollments
      const { data: enrollments } = await supabaseClient
        .from('course_enrollments')
        .select('course_id')
        .eq('user_id', user.id);

      // Get all progress
      const { data: progress } = await supabaseClient
        .from('lesson_progress')
        .select('course_id, lesson_number')
        .eq('user_id', user.id);

      renderCertificates(enrollments || [], progress || [], user);
    }

    function loadCertificatesDemo() {
      document.getElementById('user-name').textContent = 'Demo Student';

      const demoEnrollments = [
        { course_id: 1 },
        { course_id: 2 },
        { course_id: 3 }
      ];

      const demoProgress = [
        // Course 1 - Completed
        ...Array.from({ length: 20 }, (_, i) => ({ course_id: 1, lesson_number: i + 1 })),
        // Course 2 - In progress
        ...Array.from({ length: 10 }, (_, i) => ({ course_id: 2, lesson_number: i + 1 })),
        // Course 3 - Just started
        { course_id: 3, lesson_number: 1 }
      ];

      const demoUser = {
        user_metadata: { full_name: 'Demo Student' },
        email: 'demo@example.com'
      };

      renderCertificates(demoEnrollments, demoProgress, demoUser);
    }

    function renderCertificates(enrollments, progress, user) {
      // Calculate progress per course
      const courseProgress = {};
      progress.forEach(p => {
        if (!courseProgress[p.course_id]) {
          courseProgress[p.course_id] = [];
        }
        courseProgress[p.course_id].push(p.lesson_number);
      });

      let completedCount = 0;
      let inProgressCount = 0;
      let certificatesHTML = '';

      enrollments.forEach(enrollment => {
        const courseId = enrollment.course_id;
        const course = allCoursesData[courseId];

        if (!course) return;

        const completedLessons = courseProgress[courseId]?.length || 0;
        const isCompleted = completedLessons >= course.total_lessons;
        const percent = Math.round((completedLessons / course.total_lessons) * 100);

        if (isCompleted) {
          completedCount++;

          const userName = user.user_metadata?.full_name || user.email || 'Student';
          const completionDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

          certificatesHTML += `
            <div class="col-lg-6 col-xl-4">
              <div class="certificate-card mb-4">
                <div class="certificate-preview">
                  <div class="text-center">
                    <div class="certificate-badge">üèÜ</div>
                    <h6 class="text-white mt-2">Certificate of Completion</h6>
                  </div>
                </div>
                <div class="card-body">
                  <h5 class="card-title">${course.title}</h5>
                  <p class="text-muted small mb-3">
                    <i class="bi bi-calendar-check"></i> Completed on ${completionDate}
                  </p>

                  <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="downloadCertificate(${courseId}, '${course.title}', '${userName}', '${completionDate}')">
                      <i class="bi bi-download"></i> Download PDF
                    </button>
                    <div class="btn-group" role="group">
                      <button class="btn btn-outline-secondary share-btn" onclick="shareToLinkedIn('${course.title}')">
                        <i class="bi bi-linkedin"></i> LinkedIn
                      </button>
                      <button class="btn btn-outline-secondary share-btn" onclick="shareToTwitter('${course.title}')">
                        <i class="bi bi-twitter"></i> Twitter
                      </button>
                      <button class="btn btn-outline-secondary share-btn" onclick="copyLink(${courseId})">
                        <i class="bi bi-link-45deg"></i> Copy Link
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        } else {
          inProgressCount++;
        }
      });

      // Update summary stats
      document.getElementById('total-certificates').textContent = completedCount;
      document.getElementById('completed-courses').textContent = completedCount;
      document.getElementById('in-progress-courses').textContent = inProgressCount;

      // Render certificates or empty state
      if (completedCount === 0) {
        certificatesHTML = `
          <div class="col-12">
            <div class="card">
              <div class="card-body text-center py-5">
                <i class="bi bi-award" style="font-size: 5rem; color: #ddd;"></i>
                <h3 class="mt-3">No Certificates Yet</h3>
                <p class="text-muted">Complete your courses to earn certificates!</p>
                <a href="my-courses.html" class="btn btn-primary mt-3">
                  <i class="bi bi-book"></i> View My Courses
                </a>
              </div>
            </div>
          </div>
        `;
      }

      document.getElementById('certificates-grid').innerHTML = certificatesHTML;
    }

    function downloadCertificate(courseId, courseTitle, userName, completionDate) {
      // In a real implementation, this would generate a PDF certificate
      // For now, we'll show an alert
      alert(`Certificate download feature coming soon!\n\nCourse: ${courseTitle}\nStudent: ${userName}\nCompleted: ${completionDate}`);

      // TODO: Implement PDF generation using a library like jsPDF or server-side generation
      // Example implementation:
      // const { jsPDF } = window.jspdf;
      // const doc = new jsPDF();
      // doc.text(`Certificate of Completion`, 105, 50, { align: 'center' });
      // doc.text(courseTitle, 105, 70, { align: 'center' });
      // doc.text(`This certifies that ${userName}`, 105, 90, { align: 'center' });
      // doc.text(`has successfully completed this course`, 105, 100, { align: 'center' });
      // doc.text(`on ${completionDate}`, 105, 110, { align: 'center' });
      // doc.save(`certificate-${courseId}.pdf`);
    }

    function shareToLinkedIn(courseTitle) {
      const url = encodeURIComponent(window.location.origin);
      const text = encodeURIComponent(`I just completed "${courseTitle}" on Mental Health Education Platform!`);
      window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}&summary=${text}`, '_blank');
    }

    function shareToTwitter(courseTitle) {
      const url = encodeURIComponent(window.location.origin);
      const text = encodeURIComponent(`I just completed "${courseTitle}" on Mental Health Education Platform! üéì`);
      window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank');
    }

    function copyLink(courseId) {
      const link = `${window.location.origin}/student/certificates.html?course=${courseId}`;
      navigator.clipboard.writeText(link).then(() => {
        alert('Certificate link copied to clipboard!');
      });
    }

    async function signOut() {
      if (supabaseClient) {
        await supabaseClient.auth.signOut();
      }
      window.location.href = '../index.html';
    }

    document.addEventListener('DOMContentLoaded', loadCertificates);
  </script>

</body>

</html>
